<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Event @ ITAhM</title>
		
		<style>

@import "/css/style.css";
@import "/css/fa.css";
@import "/css/list.css";

header button,
header input {
	font-family: "Font Awesome 5 Free", "맑은 고딕";
	padding: 0.5em;
    height: 100%;
    box-sizing: border-box;
}

header {
    color: #ffffff;
}

.loading.mask {
    z-index: 9;
}
		</style>
		<script>
        
function toDateString(millis) {
    var date = new Date(millis),
        yyyy = date.getFullYear(),
        mm = date.getMonth() +1,
        dd = date.getDate();
    
    return `${yyyy}-${(mm > 9? "": "0") + mm}-${(dd > 9? "": "0") + dd}`;
}

function toTimeString(millis) {
    var date = new Date(millis),
        hh = date.getHours(),
        mm = date.getMinutes(),
        ss = date.getSeconds();
    
    return (hh > 9? "": "0") + hh +":"+ (mm > 9? "": "0") + mm +":"+ (ss > 9? "": "0") + ss;
}

function createItem(event) {
    const tr = document.createElement("tr");
    
    tr.appendChild(document.createElement("td")).textContent = toDateString(event.timestamp);
    tr.appendChild(document.createElement("td")).textContent = toTimeString(event.timestamp);
    tr.appendChild(document.createElement("td")).textContent = event.id;
	tr.appendChild(document.createElement("td")).textContent = event.command;
	tr.appendChild(document.createElement("td")).textContent = event.target;
    
	return tr;
}

function onSort (e) {
	const
        list = document.body.querySelector("tbody"),
        df = document.createDocumentFragment(),
        index = [].indexOf.call(this.parentNode.children, this);

	let bias;

	if (this.classList.contains("descend")) {
		this.classList.remove("descend");

		this.classList.add("ascend");

		bias = 1;
	} else {
		this.classList.remove("ascend");

		this.classList.add("descend");

		bias = -1;
	}
	
    [].slice.call(list.children)
        .sort((a, b) => a.children[index].textContent.localeCompare(b.children[index].textContent) * bias)
        .forEach(e => df.appendChild(e));

	list.appendChild(df);
}

function showMessage(xhr) {
    switch (xhr.status) {
    case 401:
        alert("Notice!\n\n"+ "세션 만료.");

        break;
    default:
        alert(`Error!\n\n오류코드: ${xhr.status}.`);
    }

    try {
        console.log(JSON.parse(xhr.responseText).error);
    } catch (e) {}
}
            
        </script>
	</head>
	
	<body class="loading">
        <header>
            <div>
                <button id="export" title="CSV 내보내기">&#xf019; Export</button>
            </div>
            <form>
                <input type="date" name="from">
                <b>~</b>
                <input type="date" name="to">
                <input type="submit" value="&#xf002; Search">
            </form>
        </header>
        <main>
            <table>
                <colgroup>
                    <col width="100">
                    <col width="100">
                    <col>
                </colgroup>
                <thead>
                    <tr>
                        <th class="sort">날짜</th>
                        <th class="sort">시간</th>
                        <th class="sort">사용자</th>
                        <th class="sort">명령</th>
                        <th class="sort">데이터</th>
                    </tr>
                </thead>
                <tbody id="list"></tbody>
            </table>
        </main>
        
		<div class="loading mask"></div>
        
        <script src="/js/ITAhM.js"></script>
        <script src="/js/request.js"></script>
		<script>

const
    search = new URLSearchParams(window.location.search),
    $ = {
        list: document.getElementById("list"),
        count: {
            normal: 0,
            critical: 0,
            shutdown: 0
        },
        date: document.getElementById("date"),
        form: document.querySelector("form")
    };

$.form.onsubmit = function (e) {
    e.preventDefault();

    const
        search = new URLSearchParams(),
        from = this.elements["from"].valueAsDate.setHours(0, 0, 0, 0),
        to = this.elements["to"].valueAsDate.setHours(0, 0, 0, 0);

    search.set("from", Math.min(from, to));
    search.set("to", Math.max(from, to));
    
    window.location.search = search;
};

[].forEach.call(document.body.querySelectorAll("th.sort"), th => th.onclick = onSort);

document.getElementById("export").onclick = function (e) {
    const rows = [];
	
	rows[0] = "Index,Date,Time,User,Command,Target";

    for (let i=0, count=$.indexArray.length, event; i<count; i++) {
        event = $.eventData[$.indexArray[i]];

        rows.push([
            i,
            toDateString(event.timestamp),
            toTimeString(event.timestamp),
            event.id,
            event.command,
            event.target
        ].join(","));
    }

    ITAhM.util.download(new Blob(["\ufeff", rows.join("\n")] ,{
		type: "text/csv;charset=utf-8;"
	}), $.fileName);
};

{
    const request = {
            command: "get",
            target: "audit"    
        };
    let
        from = Number(search.get("from")) || undefined,
        to = Number(search.get("to")) || undefined,
        date;

    if (!from) {
        date = new Date();

        from = to = date.setHours(0, 0, 0, 0);
    }

    request.from = from;
    
    date = new Date(to);
    request.to = date.setDate(date.getDate() +1)

    date = new Date(from);
    date.setHours(9, 0, 0, 0);

    $.form.elements["from"].valueAsDate = date;

    date = new Date(to);
    date.setHours(9, 0, 0, 0);

    $.form.elements["to"].valueAsDate = date;

    new Request().execute(request, function () {
        switch (this.status) {
        case 200:
            $.fileName = "audit.csv";

            $.eventData = JSON.parse(this.responseText);
            $.indexArray = Object.keys($.eventData).sort(function (a, b) {
                return parseInt(b) - parseInt(a);
            });

            const df = document.createDocumentFragment();
            
            for (let i=0, _i=$.indexArray.length, item; i<_i; i++) {
                if (item = createItem($.eventData[$.indexArray[i]])) {
                    df.appendChild(item);
                }
            }
            
            $.list.appendChild(df);
            
            document.body.classList.remove("loading");
    
            break;
        default:
            throw showMessage(this);
        }
    });
}




		</script>
	
	</body>
	
</html>