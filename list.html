<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		
		<title>List @ ITAhM</title>
		
		<style>
@import "/css/style.css";
@import "/css/fa.css";
@import "/css/list.css";

header {
    flex: none;
	padding: 1em;
	display: flex;
    justify-content: space-between;
    user-select: none;
}

tbody {
	user-select: none;
}

nav >select,
form >input{
    font-family: "Font Awesome 5 Free";
	height: 100%;
	box-sizing: border-box;
}

form input[type="text"] {
	flex: 1;
	min-width: 0;
}

nav {
	display: flex;
	align-items: center;
}

#list >ul.hidden,
body.keyword #list> ul:not(.keyword) {
	display: none;
}

		</style>
		
		<script>
// static function
const REGEXP_IPV4 = new RegExp("^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\."
	+ "(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\."
	+ "(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\."
	+ "(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$");

function IP2Int(s) {
	const o = REGEXP_IPV4.exec(s);
	
	if(o === null || o.length != 5) return 0xffffffff;
	
	var n = 0;
	for(let i=1; i<5; i++) {
		n <<= 8;
		n |= o[i];
	}
	
	return n >>> 0;
}
		</script>
		
		<script>

function onShowStatus() {
	window.sessionStorage.setItem("node_id", window.selectedID);

    window.location.href = "/resource.html";
}

function initialize() {
	const df = document.createDocumentFragment();
    let row;
    
    for (let id in $.nodeData) {
		df.appendChild(createRow(id, $.nodeData[id]));
    }
	
	document.body.querySelector("tbody").appendChild(df);
	
	document.body.classList.remove("loading");

    {
        const
            e = document.getElementById("label"),
            df = document.createDocumentFragment();
        
        for (var label in $.labelMap) {
            df.appendChild(document.createElement("option")).text = label;
        }
        
        e.insertBefore(df, e.firstChild);
    }
}

/**
 * @param {string} id
 **/
function createRow(id, node) {
	var
		row = document.createElement("tr"),
		labels, label;

    row.appendChild(document.createElement("td")); // N.0
	row.appendChild(document.createElement("td")).textContent = node.name || ""; // N.1
	row.appendChild(document.createElement("td")).textContent = node.ip || ""; // N.2

	row.dataset.id = id;
	
	if (node.label) {
		labels = node.label.split(",");
		
		for (var i=0, length=labels.length; i<length; i++) {
			label = labels[i];
			
			if (!(label in $.labelMap)) {
				$.labelMap[label] = [];
			}

			$.labelMap[label].push(row);
		}
	}
	else {
		$.labelMap[""].push(row);
	}
    
	row.draggable = true;

	row.addEventListener("dragstart", e => {
		e.dataTransfer.effectAllowed = "copy";

		e.dataTransfer.setData("id", id);
		e.dataTransfer.setData("name", node.name || node.ip || "");
	});

	return row;
}

function showMessage(xhr) {
    switch (xhr.status) {
    case 401:
        alert("Notice!\n\n"+ "세션 만료.");

        break;
    default:
        alert(`Error!\n\n오류코드 ${xhr.status}.`);
    }

    try {
        console.log(JSON.parse(xhr.responseText).error);
    } catch (e) {}
}

		</script>
		
	</head>
	
	<body class="_loading">
		<header>
			<nav>
				<select id="label">
					<optgroup>
						<option value="">미분류
					</optgroup>
					<optgroup>
						<option selected>모두 보기
					</optgroup>
				</select>
			</nav>
			<form>
				<input type="text" name="keyword" placeholder="IP, Type, Name">
				<input type="submit" value="&#xf002; 찾기">
				<input type="reset" value="&#xf0e2; 초기화">
			</form>
		</header>
		<main>
			<table>
				<colgroup>
					<col width="50">
					<col width="200">
					<col width="200">
				</colgroup>
				<thead>
					<tr>
						<th>
							<input type="checkbox">
						</th>
						<th class="sort">Name</th>
						<th class="sort">IP</th>
						<th></th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td>
							<input type="checkbox">
						</td>
						<td>게이트웨이</td>
						<td>192.168.100.1</td>
						<td></td>
					</tr>
					<tr>
						<td>
							<input type="checkbox">
						</td>
						<td>개발자</td>
						<td>192.168.100.60</td>
						<td></td>
					</tr>
					<tr>
						<td>
							<input type="checkbox">
						</td>
						<td>서버</td>
						<td>192.168.100.50</td>
						<td></td>
					</tr>
				</tbody>
			</table>
		</main>
		
		<div class="loading mask"></div>
		
        <script src="/js/ITAhM.js"></script>
        <script src="/js/icon.js"></script>
		<script src="/js/object.js"></script>
		<script src="/js/request.js"></script>
		<script>

const $ = {
        request: new Request(),
        iconData: ITAhM.iconData,
        labelMap: {
		"": []
	    }
    };
        
document.getElementById("label").onchange = function () {
	const
		df = document.createDocumentFragment(),
		label = this.value;
	
	document.body.classList.add("loading");
	
	if (this.selectedIndex === this.options.length -1) {
		for (let row; row = $.list.firstElementChild;) {
			df.appendChild(row).classList.remove("hidden");
		}
	}
	else {
		for (let row; row = $.list.firstElementChild;) {
			df.appendChild(row).classList[$.labelMap[label].indexOf(row) == -1? "add": "remove"]("hidden");
		}
	}
	
	$.list.appendChild(df);

	document.body.classList.remove("loading");
};

function onSort (e) {
	const
        df = document.createDocumentFragment(),
        list = document.body.querySelector("tbody"),
        index = [].indexOf.call(this.parentNode.children, this);

	let bias;

	if (this.classList.contains("descend")) {
		this.classList.remove("descend");

		this.classList.add("ascend");

		bias = 1;
	} else {
		this.classList.remove("ascend");

		this.classList.add("descend");

		bias = -1;
	}
	
    [].slice.call(list.children)
        .sort((a, b) => a.children[index].textContent.localeCompare(b.children[index].textContent) * bias)
        .forEach(e => df.appendChild(e));

	list.appendChild(df);
}

[].forEach.call(document.body.querySelectorAll("th.sort"), th => th.onclick = onSort);

document.body.querySelector("th>input[type=checkbox]").onclick = function (e) {
	const checked = this.checked;

	[].forEach.call(document.body.querySelector("tbody").children, tr => {
		tr.querySelector("input[type=checkbox").checked = checked;
	});
};

(function (form) {
	form.onsubmit = function (e) {
		e.preventDefault();
		
		document.body.classList.add("loading", "keyword");

		const keyword = form.elements["keyword"].value;

		if (!keyword) {
			resetKeyWord();

			return;
		}

		const df = document.createDocumentFragment();
		
		for (let row, cols; row = $.list.firstElementChild;) {
			cols = row.children;

			df.appendChild(row);

			for (var i=0, length=cols.length; i<length; i++) {
				row.classList.remove("keyword");

				if (cols[i].textContent.indexOf(keyword) !== -1) {
					row.classList.add("keyword");
					
					break;
				}
			}
		}
		
		$.list.appendChild(df);

		document.body.classList.remove("loading");
	};

	form.onreset =  resetKeyWord;

	function resetKeyWord() {
		const df = document.createDocumentFragment();

		document.body.classList.add("loading");
		
		for (let row; row = $.list.firstElementChild;) {
			df.appendChild(row).classList.remove("keyword");
		}

		document.body.classList.remove("keyword");

		$.list.appendChild(df);

		document.body.classList.remove("loading");
	}

}) (document.querySelector("form"));

function initIcon(e) {
    switch(this.status) {
    case 200:
        const iconData = JSON.parse(this.responseText);

        for (let type in iconData) {
            $.iconData[type] = iconData[type];
        }
        
        initialize();
        
        break;
    default:
        showMessage(this);
    }
}

function initNode(e) {
    switch(this.status) {
    case 200:
        $.nodeData = JSON.parse(this.responseText);
        
        $.request.execute({
            "command": "get",
            "target": "icon"
        }, initIcon);

        break;
    default:
        showMessage(this);
    }
}
/*
$.request.execute({
    "command": "get",
    "target": "node",
    "filter": "node"
}, initNode);
*/
        </script>
	
	</body>
	
</html>