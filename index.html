<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>CeMS</title>
		
		<style>

@import "/css/var.css";
@import "/css/fa.css";
@import "/css/skin/index.css";
@import "/css/skin/type1.css";

        </style>
        <script>

function Commander() {
    this.initialize(arguments);
}

{
    function getAccount(msg, account) {
        new BroadcastChannel(msg.channel).postMessage(account);
    }

    Commander.prototype = {
        initialize: function (args) {
            this.account = args[0];
            this.map = {
                get: {
                    account: getAccount
                }
            };
        },
        execute: function (msg) {
            this.map[msg.command][msg.target](msg, this.account);
        }
    };
}

function signIn(account) {
    $.request = new Request();

    window.account = account;

    if (account.level === 0) {
        document.body.classList.add("root");
    }

    document.title = $.request.agent;

    document.getElementById("user").title = account.id;
    document.getElementById("signout").onclick = onSignOut;

    {
        const commander = new Commander(account);

        new BroadcastChannel("bc_root").onmessage = e => commander.execute(e.data);
    }

    $.request.execute({
        command: "get",
        target: "setting"
    }, function () {
        switch (this.status) {
        case 200:
            const
                settingData = JSON.parse(this.responseText);
            let home = "about:blank";

            if (!("mute" in settingData) || settingData.mute === "false") {
                $.sound = new Audio("/siren.mp3");
            }

            $.request.listen(e => {
                onEvent(e);

                Channel.sendEvent(e);
            });

            if ("home" in settingData) {
                switch (settingData.home) {
                case "1":
                    home = "/topology.html";

                    break;
                case "2":
                    home = "/branch.html";

                    break;
                case "3":
                    home = "/dc.html";

                    break;
                case "4":
                    home = "/TopTen.html";

                    break;
                }
            }

            document.getElementById("main").src = home;
            document.getElementById("status").src = "/status.html";

            document.body.classList.add("authorized");

            break;
        default:
            showMessage(this);
        }
    });
}

function toElapseString(millis) {
    const elapse = new Date().getTime() - millis;

    if (elapse < 60 *1000) {
        return `${Math.round(elapse /1000)}초 전`;
    } else if (elapse < 60 *60 *1000) {
        return `${Math.round(elapse /60 /1000)}분 전`;
    } else if (elapse < 24 *60 *60 *1000) {
        return `${Math.round(elapse /60 /60 /1000)}시간 전`;
    } else {
        return `${Math.round(elapse /24 /60 /60 /1000)}일 전`;
    }
}

function onEvent(event) {
    if (event == null) {
        alert("Error!\n\n"+
            "리스너 응답 없음.");

        window.location.reload();
    }

    if (event.level < 0) {
        alert("Notice.\n\n"+
            "관리자가 서비스를 종료하였습니다.");

        return signOut();
    }

    const div = document.createElement("div");

    div.dataset.timestamp = new Date().getTime();
    div.dataset.elapse = "지금";
    div.dataset.message = `${event.name || event.ip || ""} ${event.message}`;

    document.body.querySelector("footer").appendChild(div);

    document.body.classList.add("event");

    switch(event.origin) {
    case "critical":
    case "status":
    case "snmp":
    case "updown":
        break;

    case "register":
    case "search":
    case "system":
    case "warning":
        break;
    }

    if (event.level == 2 && $.sound) {
        try {
            $.sound.play();
        } catch (e) {
            console.log(e);
        };
    }
}

function showDialog(src, parent) {
    const dialog = document.getElementById("dialog");

    dialog.onload = function () {
        $.parent = parent;

		document.body.classList.add("dialog");
	};

    dialog.src = src;
}

function closeDialog(reset) {
    const dialog = document.getElementById("dialog");

    document.body.classList.remove("dialog");

    dialog.onload = undefined;
    
    dialog.src = "about:blank";

    if (reset) {
        resetParent();
    }

    delete $.parent;
}

function resetParent() {
    if ($.parent) {
        $.parent.location.reload();
    }
}

function signOut() {
    document.body.classList.add("loading");

    $.request.execute({
        command: "signout"
    }, function () {
        window.location.reload();
    });
}

function onSignOut() {
    if (confirm(CONFIRM_SIGNOUT["kr"])) {
        signOut();
    }
}

function showMessage(xhr) {
    switch (xhr.status) {
    default:
        alert(ERROR_RES_CODE(xhr.status)["kr"]);
    }

    try {
        console.log(JSON.parse(xhr.responseText).error);
    } catch (e) {}
}

function onTest(e) {
    const reader = new FileReader();

    reader.onload = function (e) {
        const rows = reader.result.split(/\r?\n/);
        const locationData = {};
        let location;

        rows.forEach((row,i) => {
            const cols = row.split(",");
            
            location = {
                rack: Number(cols[0]),
                position: Number(cols[1]),
                maker: cols[2],
                model: cols[3],
                name: cols[5] || "",
            };

            if (cols[6]) {
                location.ip = cols[6];
            }

            locationData[String(i +1)] = location;
        });
        
        $.request.execute({
            command: "test",
            location: locationData
        }, function (e) {
            console.log(this.status);
        });
    };

    reader.readAsText(e.target.files[0], "UTF-8");
}
        </script>
    </head>
    <body class="status">
        <header>
            <nav>
                <ul>
                    <li>
                        <b></b>
                    </li>
                    <li title="토폴로지">
                        <a href="/topology.html" target="main">
                            &#xf0e8;
                            <div>토폴로지</div>
                        </a>
                        <ul>
                            <li>
                                <a href="/topology.html" target="main">&#xf06e; 보기</a>
                            </li>
                            <li>
                                <a href="/topology/editor.html" target="main">&#xf044; 편집</a>
                            </li>
                        </ul>
                    </li>
                    <li title="지도">
                        <a href="/branch.html" target="main">
                            &#xf3c5;
                            <div>지도</div>
                        </a>
                    </li>
                    <li title="데이터센터">
                        <a href="/dc.html" target="main">
                            &#xf64f;
                            <div>DC</div>
                        </a>
                        <ul>
                            <li>
                                <a href="/dc.html" target="main">&#xf06e; 보기</a>
                            </li>
                            <li>
                                <a href="/dc/editor.html" target="main">&#xf044; 편집</a>
                            </li>
                        </ul>
                    </li>
                    <li title="Top Ten">
                        <a href="/topTen.html" target="main">
                            &#xf160;
                            <div>탑텐</div>
                        </a>
                    </li>
                    <li>
                        <b></b>
                    </li>
                    <li title="이벤트">
                        <a href="/event.html" target="main">
                            &#xf783;
                            <div>이벤트</div>
                        </a>
                    </li>
                    <li title="감사">
                        <a href="/audit.html" target="main">
                            &#xf1e5;
                            <div>감사</div>
                        </a>
                    </li>
                    <li>
                        <b></b>
                    </li>
                    <li title="리스트">
                        <a>
                            &#xf0ca;
                            <div>리스트</div>
                        </a>
                        <ul>
                            <li>
                                <a href="/node/viewer.html" target="main">&#xf233; 노드</a>
                            </li>
                            <li>
                                <a href="/group.html" target="main">&#xf126; 브랜치</a>
                            </li>
                            <li>
                                <a href="/link.html" target="main"> &#xf83e; 회선</a>
                            </li>
                            <li>
                                <a href="/user.html" target="main">&#xf0c0; 사용자</a>
                            </li>
                        </ul>
                    </li>
                    <li title="기능">
                        <a>
                            &#xf141;
                            <div>기능</div>
                        </a>
                        <ul>
                            <li>
                                <a href="/critical.html" target="main">
                                    &#xf08d; 임계
                                </a>
                            </li>
                            <li>
                                <a href="/icon.html" target="main">
                                    &#xf61f; 아이콘
                                </a>
                            </li>
                            <li>
                                <a href="/setting.html" target="main">
                                    &#xf013; 설정
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <b></b>
                    </li>
                    <li title="Home">
                        <a href="/">
                            &#xf015;
                            <div>홈</div>
                        </a>
                    </li>
                </ul>
                <ul>
                    <li id="user">
                        <a href="/">
                            &#xf011;
                        </a>
                        <ul>
                            <li id="password">
                                <a>&#xf084; 비밀번호</a>
                            </li>
                            <li id="signout">
                                <a>&#xf2f5; 나가기</a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </nav>
        </header>
        <article>
            <aside>
                <iframe name="status" id="status"></iframe>
                <div id="tab"></div>
            </aside>
            <main>
                <iframe name="main" id="main" src="/connect.html"></iframe>
            </main>
        </article>
        <footer></footer>
        <iframe id="dialog" name="dialog"></iframe>

        <script src="/js/request.js"></script>
        <script src="/js/constants.js"></script>
        <script src="/js/channel.js"></script>
        <script>

const $ = {
        event: document.getElementById("event"),
        popups: []
    };

((open) => {
    window.open = (url, name) => {
        if (name) {
            open(url, name);
        } else {
            $.popups.push(open(url,
                "_blank",
                `left=${window.innerWidth /4},top=${window.innerHeight /4},width=${window.innerWidth /2},height=${window.innerHeight /2}`));
        }
    };
})(window.open);

window.onunload = e => $.popups.forEach(wnd => wnd.close());

document.getElementById("tab").onclick = function (e) {
    document.body.classList.toggle("status");
};

document.querySelector("footer").onclick = function (e) {
    for (let event; event = this.firstChild; ) {
        this.removeChild(event);
    }
    
    document.body.classList.remove("event");

    document.getElementById("main").src = "/event.html";
};

document.getElementById("password").onclick = e => {
    //document.querySelector("div.account details").open = false;
    
    showDialog("/dialog/password.html");
}

function refreshEvent() {
    Array
        .from(document.querySelector("footer").children)
        .forEach(event => (event.dataset.elapse = toElapseString(event.dataset.timestamp)));
    
    setTimeout(() => window.requestAnimationFrame(refreshEvent), 1000);
}

refreshEvent();

        </script>
        
    </body>
</html>