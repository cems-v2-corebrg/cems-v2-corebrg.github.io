<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Event @ ITAhM</title>
		
		<style>

@import "/css/style.css";
@import "/css/fa.css";
@import "/css/list.css";

input[type=button] {
	font-family: "Font Awesome 5 Free", "맑은 고딕";
	padding: 0.5em;
}

thead th {
    font-family: "Font Awesome 5 Free", "맑은 고딕";
}

#list tr {
    cursor: pointer;
}

body:not(.root) .root {
    display: none;
}

		</style>
		<script>

function createItem(user) {
    const tr = document.createElement("tr");
    
    tr.appendChild(document.createElement("td")).textContent = user.id;
    tr.appendChild(document.createElement("td")).textContent = user.name;
    tr.appendChild(document.createElement("td")).textContent = user.level === 0?
        "관리자": user.level === 1?
        "사용자": "수신자";
    tr.appendChild(document.createElement("td")).textContent = user.email || "";
    tr.appendChild(document.createElement("td")).textContent = user.sms || "";

    tr.onclick = e => top.showDialog(`/dialog/user.html?id=${user.id}`, window);

	return tr;
}

function onAddUser (e) {
    top.showDialog("/dialog/user.html", window);
}

function showMessage(xhr) {
    switch (xhr.status) {
    case 401:
        alert("Notice!\n\n"+ "세션 만료.");

        break;
    default:
        alert(`Error!\n\n오류코드: ${xhr.status}.`);
    }

    try {
        console.log(JSON.parse(xhr.responseText).error);
    } catch (e) {}
}
            
        </script>
	</head>
	
	<body class="loading">
        <header>
            <nav>
                <input type="button" value="&#xf067; Add" id="add" class="root" title="사용자 추가">
                <input type="button" value="&#xf019; Export" id="export" title="CSV 내보내기">
            </nav>
        </header>
        <main>
            <table>
                <colgroup>
                    <col>
                    <col>
                    <col>
                    <col>
                    <col width="160">
                </colgroup>
                <thead>
                    <tr>
                        <th>&#xf507; 아이디</th>
                        <th>&#xf004; 이름</th>
                        <th>&#xf005; 권한</th>
                        <th>&#xf0e0; 이메일</th>
                        <th>&#xf3cd; 모바일</th>
                    </tr>
                </thead>
                <tbody id="list"></tbody>
            </table>
        </main>
        
		<div class="loading mask"></div>
        
        <script src="/js/ITAhM.js"></script>
        <script src="/js/request.js"></script>
		<script>

const
    $ = {
        list: document.getElementById("list")
    };

if (top.account.level === 0) {
    document.body.classList.add("root");

    document.getElementById("add").onclick = onAddUser;
}

document.getElementById("export").onclick = function (e) {
    const rows = [];
	
	rows[0] = "Index,ID,Level,Name,Email,Mobile";

    {
        let user, count=0;

        for (let key in $.userData) {
            user = $.userData[key];

            rows.push([
                count++,
                `"${user.id.replace(/\"/g, "'")}"`,
                user.level === 0? "관리자": user.level === 1? "사용자": "수신자",
                `"${user.name.replace(/\"/g, "'")}"`,
                user.email || "",
                user.sms && user.sms.replace(/(^02.{0}|^01.{1}|[0-9]{3})([0-9]+)([0-9]{4})/,"$1-$2-$3") || ""
            ].join(","));    
        }
    }
    
    ITAhM.util.download(new Blob(["\ufeff", rows.join("\n")] ,{
		type: "text/csv;charset=utf-8;"
	}), $.fileName);
};

{
    new Request().execute({
        command: "get",
        target: "user"
    }, function () {
        switch (this.status) {
        case 200:
            $.fileName = "user.csv";
            $.userData = JSON.parse(this.responseText);
            
            const df = document.createDocumentFragment();
            let item;

            for (let key in $.userData) {
                if (item = createItem($.userData[key])) {
                    df.appendChild(item);
                }
            }
            
            $.list.appendChild(df);
            
            document.body.classList.remove("loading");
    
            break;
        default:
            showMessage(this);
        }
    });
}

		</script>
	
	</body>
	
</html>