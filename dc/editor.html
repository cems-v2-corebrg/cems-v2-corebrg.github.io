<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <style>
@import "/css/style.css";
@import "/css/fa.css";

body {
    position: fixed; inset: 0 0 0 0;
    padding: 0; margin: 0;
    font: 12px "맑은 고딕";
    /*background-color: rgba(0, 0, 0, 0.8);*/
    background-color: #101010;
    display: flex; flex-direction: column;
}

header {
    flex: none;
    background-color: #dddddd;
    color: #7f7f7f;
}

main {
    flex: 1;
}

iframe {
    width: 100%; height: 100%;
    border: none;
}

ul {
    list-style: none;
    margin: 0; padding: 0;
    display: flex;
    overflow-x: auto;
}

li {
    padding: 0.5em 2em 0.5em 1em;
    border-right: 1px solid #aaaaaa;
    cursor: pointer;
    position: relative;
}

li.selected {
    font-weight: bold;
    color: #fefefe;
    background-color: #101010;
}

header li:last-of-type {
    width: 2em;
    padding-right: 1em;
    text-align: center;
    font-family: "Font Awesome 5 Free", "맑은 고딕";
}

li span {
    position: absolute; inset: 0.5em 0.5em 0.5em auto;
    display: block;
}

li span::after {
    font-family: "Font Awesome 5 Free", "맑은 고딕";
    content: "\f00d";
}

li span:hover {
    transform: scale(1.2);
}

        </style>
        <script>

function openDC(e) {
    const
        container = document.body.querySelector("header ul"),
        rect = container.getBoundingClientRect();
    
    document.body.classList.add("loading");

    Array.from(container.querySelectorAll("li"))
        .forEach(li => li.classList.remove("selected"));

    this.classList.add("selected");

    document.body.querySelector("iframe").src = `/dc/tool.html?name=${this.textContent}`;
}

function removeDC(e) {
    e.stopPropagation();

    if (!confirm("Confirm.\n\n데이터센터를 삭제하겠습니까?")) {
        return;
    }

    document.body.classList.add("loading");

    delete window.positionData[this.parentNode.textContent];

    $.request.execute({    
        command: "set",
        target: "position",
        name: "dc",
        position: window.positionData
    }, function (e) {
        switch (this.status) {
        case 200:
            break;
        default:
            throw showMessage(this);
        }

        location.search = new URLSearchParams();
    });
}

function showMessage(xhr) {
    switch (xhr.status) {
    case 401:
        alert("Notice!\n\n"+ "세션 만료.");

        break;
    default:
        alert(`Error!\n\n오류코드 ${xhr.status}.`);
    }

    try {
        console.log(JSON.parse(xhr.responseText).error);
    } catch (e) {}
}
            
        </script>        
    </head>
        
    <body class="loading">
        <header>
            <ul>
                <li title="데이터 센터 추가">&#xf067;</li>
            </ul>
        </header>
        <main>
            <iframe></iframe>
        </main>
        
        <div class="loading mask"></div>

        <script src="/js/request.js"></script>
        <script>
const
    search = new URLSearchParams(window.location.search),
    $ = {
        request: new Request(),
        name: search.get("name")
    };

var positionData = {};

document.body.querySelector("header li:last-of-type").onclick = e => {
    const name = prompt("데이터센터 이름을 입력하세요.");

    if (name) {
        if (name in window.positionData) {
            return alert("Error!\n\n사용중인 이름.");
        }
        
        window.positionData[name] = {
            size: {
                width: 10000,
                height: 10000
            },
            position: {}
        };

        document.body.classList.add("loading");

        $.request.execute({
            command: "set",
            target: "position",
            name: "dc",
            position: window.positionData
        }, function () {
            switch (this.status) {
            case 200:
                break;

            default:
                throw showMessage(this);
            }

            alert("Information.\n\n저장 완료.");

            const search = new URLSearchParams();

            search.set("name", name);
            
            window.location.search = search;
        });
    }
};

$.request.execute({
    command: "get",
    target: "position",
    name: "dc"
}, function (e) {
    switch(this.status) {
    case 200:
        window.positionData = JSON.parse(this.responseText);
    case 204:
        break;
    default:
        throw showMessage(this);
    }
    
    const
        container = document.body.querySelector("header ul"),
        iframe = document.querySelector("iframe"),
        df = document.createDocumentFragment();
    let li, span;

    for (let name in positionData) {
        li = document.createElement("li");
        span = document.createElement("span");

        if (name === $.name) {
            li.classList.add("selected");
        }

        li.textContent = name;

        li.onclick = openDC;

        span.onclick = removeDC;

        df.appendChild(li)
            .appendChild(span);
    }

    container.insertBefore(df, container.lastElementChild);

    iframe.onload = e => 
        document.body.classList.remove("loading");

    iframe.src = $.name && `/dc/tool.html?name=${$.name || ""}` || "about:blank";
});
        </script>
    </body>
</html>