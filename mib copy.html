<!DOCTYPE html>
<html>
	<head>
        <title>test</title>
		<meta charset="UTF-8">		
		<style>

@import "/css/style.css";
@import "/css/list.css";
@import "/css/fa.css";

main.from {
	flex: 0.5;
}

main.to.drop {
	outline: 5px dotted #0f0f0f;
}

header {
	line-height: 3em;
}

header :is(input, select) {
	font-family: "Font Awesome 5 Free", "맑은 고딕";
	height: 100%;
	padding: 0 0.5em;
}

tbody {
	user-select: none;
}

		</style>
		<script>
function createItem(oid, mib) {
	const
		tr = document.createElement("tr"),
		checkbox = document.createElement("input");

	checkbox.type = "checkbox";

	tr.appendChild(document.createElement("th")).appendChild(checkbox);
	tr.appendChild(document.createElement("td")).textContent = oid;
	tr.appendChild(document.createElement("td")).textContent = mib.match || "";
	tr.appendChild(document.createElement("td")).textContent = "";
	tr.appendChild(document.createElement("td")).textContent = mib.trace? "Y": "";

	checkbox.dataset.oid = oid;
	
	tr.draggable = true;
	tr.ondragstart = onDragStart;

	return tr;
}

function createSyncItem (name, oid) {
	const
		tr = document.createElement("tr"),
		checkbox = document.createElement("input");

	checkbox.type = "checkbox";

	tr.appendChild(document.createElement("th")).appendChild(checkbox);
	tr.appendChild(document.createElement("td")).textContent = name;
	tr.appendChild(document.createElement("td")).textContent = oid.type;
	tr.appendChild(document.createElement("td")).textContent = oid.value;
	tr.appendChild(document.createElement("td")).textContent = oid.log? "Y": "";

	checkbox.dataset.name = name;
	checkbox.dataset.type = oid.type;
	checkbox.dataset.value = oid.value;
	
	if (oid.log) {
		checkbox.dataset.log = true;
	}

	return tr;
}

function createListItem (name, oid) {
	const tr = document.createElement("tr");

	tr.appendChild(document.createElement("td")).textContent = name;
	tr.appendChild(document.createElement("td")).textContent = oid.type;
	tr.appendChild(document.createElement("td")).textContent = oid.value;
	tr.appendChild(document.createElement("td")).textContent = oid.log? "Y": "";

	tr.dataset.name = name;

	tr.onclick = onSelectItem;

	return tr;
}

function onDragStart (e) {
	if (!this.querySelector("[type=checkbox]").checked) {
		return e.preventDefault();
	}

	e.dataTransfer.effectAllowed = "copy";
}

function onSelectItem () {
	top.showDialog(`/dialog/oid.html?name=${this.dataset.name}`, window);
}

function onCheckAll () {
	const checked = this.checked;

	Array
		.from(document.body.querySelectorAll("main.from tbody input[type=checkbox]"))
		.forEach(checkbox => checkbox.checked = checked);
}

function onCheckItem () {
	if (!this.checked) {
		document.body.querySelector("main.from thead input[type=checkbox]").checked = false;
	} else if (document.body.querySelectorAll("main.from tbody input[type=checkbox]:not(:checked)").length === 0) {
		document.body.querySelector("main.from thead input[type=checkbox]").checked = true;
	}
}

function sync(array) {
	const request = array.pop();

	if (request) {
		$.request.query({
			"command": "set",
			"target": "oid",
			"value": value
		})
		.then(oidData => {
			sync(array);
		})
		.catch(showMessage);
	} else {
		alert("Information.\n\nOID 동기화 완료.");

		window.location.reload();
	}
}

function onSync() {
	const checked = document.body.querySelectorAll("main.from tbody input[type=checkbox]:checked");

	if (!confirm(`Confirm.\n\n선택한 ${checked.length} 개의 OID를 동기화 하겠습니까?`)) {
		return;
	}

	const
		sync = array => {
			const query = array.pop();

			if (query) {
				$.request.query({
					command: "set",
					target: "mib",
					mib: value
				})
				.then(mib => {
					sync(array);
				})
				.catch(showMessage);		
			} else {
				alert("Information.\n\nOID 동기화 성공.");

				window.location.reload();
			}
		},
		queryArray = [];

	Array.from(checked).forEach(checkbox => {
		queryArry.add({
			//checkbox.oid
		});
	});
	
	sync(queryArray);
	
}

function showMessage (xhr) {
    if (xhr instanceof XMLHttpRequest) {
        switch (xhr.status) {
        case 401:
            alert(NOTICE_SESS_EXPIRE["kr"]);

            break;
        default:
            alert(ERROR_RES_CODE(xhr.status)["kr"]);
        }

        try {
            console.log(JSON.parse(xhr.responseText).error);
        } catch (e) {}
    } else if (xhr instanceof Error) {
        console.error(xhr);
    } else {
        console.trace();
    }
}
		</script>
	</head>
	
	<body class="loading">
		<header>
			<div>
				<input type="button" value="&#xf2f1; Sync" id="sync" title="동기화" disabled>
				<input type="button" value="&#xf067; Add" id="add" title="OID 추가">
			</div>
		</header>
		<main class="from">
			<table>
				<colgroup>
					<col width="50">
				</colgroup>
				<thead>
					<tr>
						<th>
							<input type="checkbox">
						</th>
						<th>OID</th>
						<th>Match</th>
						<th></th>
						<th>Trace</th>
					</tr>
				</thead>
				<tbody></tbody>
				<tbody></tbody>
			</table>
		</main>
		<main class="to">
			<table>
				<thead>
					<tr>
						<th>Name</th>
						<th>Type</th>
						<th>OID</th>
						<th>Logging</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
		</main>
		<div class="loading mask"></div>

		<script src="/js/request.js"></script>
		<script src="/js/query.js"></script>
		<script src="/js/constants.js"></script>
        <script>
const
	$ = {
		request: new Request()
	};

$.request.query({
    command: "get",
    target: "oid"
})
.then(data => {
	const df = document.createDocumentFragment();
/*
	Object.keys(oidData)
		.sort()
		.forEach(name => (!(name in data)) && df.appendChild(createSyncItem(name, oidData[name])));
*/	
	

	Object.keys(data)
		.sort()
		.forEach(name => df.appendChild(createListItem(name, data[name])));
	
	//document.body.querySelector(".list tbody").appendChild(df);
})
.then(() => {
	Array
		.from(document.body.querySelectorAll("main.from input[type=checkbox]"))
		.forEach(checkbox => checkbox.onclick = onCheckItem);

	document.getElementById("add").onclick = e=> top.showDialog("/dialog/oid.html", window);

	const to = document.querySelector("main.to");

	to.addEventListener("dragenter", function (e) {
		e.preventDefault();

		to.classList.add("drop");
	});

	
	to.addEventListener("dragleave", function (e) {
		e.preventDefault();

		to.classList.remove("drop");
	});

	to.addEventListener("dragover", function (e) {
		e.preventDefault();

		e.dataTransfer.dropEffect = "copy";
	});

	to.addEventListener("drop", function (e) {
		e.stopPropagation();

		onSync();
	});

	document.body.classList.remove("loading");
})
.catch(showMessage);
		</script>
		<script type="module">
import {mibData} from "../js/mib.js";

const df = document.createDocumentFragment();

for (let oid in mibData) {
	df.appendChild(createItem(oid, mibData[oid]));
}

document.body.querySelector("main.from thead input[type=checkbox]").onclick = onCheckAll;

document.body.querySelector("main.from tbody").appendChild(df);
		</script>
	
	</body>
	
</html>